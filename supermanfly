-- Services
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local hrp = character:WaitForChild("HumanoidRootPart")
local originalGravity = Workspace.Gravity

-- Variables
local isFlying = false
local flightSpeed = 120
local toggleKey = Enum.KeyCode.Q
local waitingForKeybind = false
local isMinimized = false

local moveState = {forward = 0, backward = 0, left = 0, right = 0}
local currentCF = nil
local lerpCoef = 0.2
local currentVelocity = Vector3.new(0,0,0)

local bobbingFrequency = 3
local bobbingAmplitude = 2

local flightConns = {}
local globalConns = {}
local currentAnimTrack = nil

-- Disable/Enable default Animate
local function disableDefaultAnimate()
	local animate = character:FindFirstChild("Animate")
	if animate then animate.Disabled = true end
end
local function enableDefaultAnimate()
	local animate = character:FindFirstChild("Animate")
	if animate then animate.Disabled = false end
end

-- Play/Stop animation
local function playAnimation(animId, startTime, speed)
	if currentAnimTrack then currentAnimTrack:Stop(0.1); currentAnimTrack = nil end
	disableDefaultAnimate()
	for _, track in ipairs(humanoid:GetPlayingAnimationTracks()) do track:Stop() end
	local anim = Instance.new("Animation")
	anim.AnimationId = "rbxassetid://"..tostring(animId)
	currentAnimTrack = humanoid:LoadAnimation(anim)
	currentAnimTrack:Play()
	currentAnimTrack.TimePosition = startTime
	currentAnimTrack:AdjustSpeed(speed)
end

local function stopAnimation()
	if currentAnimTrack then currentAnimTrack:Stop(0.1); currentAnimTrack = nil end
	enableDefaultAnimate()
	for _, track in ipairs(humanoid:GetPlayingAnimationTracks()) do track:Stop() end
end

-- Create element helper
local function createElement(className, properties, parent)
	local obj = Instance.new(className)
	for prop, val in pairs(properties) do obj[prop] = val end
	if parent then obj.Parent = parent end
	return obj
end

-- GUI
local flyGui = createElement("ScreenGui",{Name="FlyGui", ResetOnSpawn=false}, player:WaitForChild("PlayerGui"))

local mainFrame = createElement("Frame", {
	Name="MainFrame",
	Size=UDim2.new(0,205,0,95),
	Position=UDim2.new(0.5,-105,0.5,-67),
	BackgroundColor3=Color3.fromRGB(30,15,0),
	BackgroundTransparency=0.35,
	BorderSizePixel=0,
	Active=true
}, flyGui)
createElement("UICorner",{CornerRadius=UDim.new(0,12)}, mainFrame)

-- Shadow
local shadow = createElement("Frame",{
	Size=mainFrame.Size,
	Position=mainFrame.Position + UDim2.new(0,2,0,2),
	BackgroundColor3=Color3.fromRGB(0,0,0),
	BackgroundTransparency=0.6,
	ZIndex=5,
	Visible=false
}, flyGui)
createElement("UICorner",{CornerRadius=UDim.new(0,12)}, shadow)
mainFrame:GetPropertyChangedSignal("Position"):Connect(function() shadow.Position = mainFrame.Position + UDim2.new(0,2,0,2) end)
mainFrame:GetPropertyChangedSignal("Size"):Connect(function() shadow.Size = mainFrame.Size end)

-- Header
local titleBar = createElement("Frame",{
	Size=UDim2.new(1,0,0,30),
	ZIndex=11,
	Parent=mainFrame,
	BackgroundTransparency=0
}, mainFrame)
local uiGradient = Instance.new("UIGradient", titleBar)
uiGradient.Color = ColorSequence.new({ColorSequenceKeypoint.new(0,Color3.fromRGB(255,120,0)), ColorSequenceKeypoint.new(1,Color3.fromRGB(40,0,0))})
createElement("UICorner",{CornerRadius=UDim.new(0,12)}, titleBar)

local titleText = createElement("TextLabel",{
	Size=UDim2.new(1,0,1,0),
	BackgroundTransparency=1,
	Text="BRD Fly",
	Font=Enum.Font.GothamBold,
	TextSize=18,
	TextColor3=Color3.fromRGB(255,180,0),
	ZIndex=12
}, titleBar)

-- Close and Minimize
local minimizeButton = createElement("TextButton",{
	Size=UDim2.new(0,24,0,24),
	Position=UDim2.new(1,-55,0,3),
	BackgroundColor3=Color3.fromRGB(255,120,0),
	BackgroundTransparency=0.25,
	Text="â€“",
	TextColor3=Color3.fromRGB(0,0,0),
	Font=Enum.Font.GothamBold,
	TextSize=16,
	ZIndex=12
}, titleBar)
createElement("UICorner",{CornerRadius=UDim.new(0,6)}, minimizeButton)
local minGlow = Instance.new("UIStroke", minimizeButton)
minGlow.Color = Color3.fromRGB(255,180,0)
minGlow.Transparency = 0.3

local closeButton = createElement("TextButton",{
	Size=UDim2.new(0,24,0,24),
	Position=UDim2.new(1,-30,0,3),
	BackgroundColor3=Color3.fromRGB(255,60,0),
	BackgroundTransparency=0.25,
	Text="X",
	TextColor3=Color3.fromRGB(0,0,0),
	Font=Enum.Font.GothamBold,
	TextSize=16,
	ZIndex=12
}, titleBar)
createElement("UICorner",{CornerRadius=UDim.new(0,6)}, closeButton)
local closeGlow = Instance.new("UIStroke", closeButton)
closeGlow.Color = Color3.fromRGB(255,120,0)
closeGlow.Transparency = 0.3

-- Toggle button
local toggleButton = createElement("TextButton",{
	Size=UDim2.new(0,90,0,25),
	Position=UDim2.new(0.5,5,0,65),
	BackgroundColor3=Color3.fromRGB(255,140,0),
	BackgroundTransparency=0.25,
	Text="FLY: OFF",
	TextColor3=Color3.fromRGB(0,0,0),
	Font=Enum.Font.GothamBold,
	TextSize=14,
	ZIndex=12
}, mainFrame)
createElement("UICorner",{CornerRadius=UDim.new(0,6)}, toggleButton)
local toggleGlow = Instance.new("UIStroke", toggleButton)
toggleGlow.Color = Color3.fromRGB(255,165,0)
toggleGlow.Thickness = 1
toggleGlow.Transparency = 0.4

-- Keybind button
local keybindButton = createElement("TextButton",{
	Size=UDim2.new(0,90,0,25),
	Position=UDim2.new(0,5,0,65),
	BackgroundColor3=Color3.fromRGB(255,140,0),
	BackgroundTransparency=0.25,
	Text="KEYBIND: "..toggleKey.Name,
	TextColor3=Color3.fromRGB(0,0,0),
	Font=Enum.Font.GothamBold,
	TextSize=14,
	ZIndex=12
}, mainFrame)
createElement("UICorner",{CornerRadius=UDim.new(0,6)}, keybindButton)
local keyGlow = Instance.new("UIStroke", keybindButton)
keyGlow.Color = Color3.fromRGB(255,165,0)
keyGlow.Thickness = 1
keyGlow.Transparency = 0.4

-- Speed slider above buttons
local speedFrame = createElement("Frame",{Size=UDim2.new(0,200,0,25),Position=UDim2.new(0,5,0,35),BackgroundTransparency=1},mainFrame)
local speedLabel = createElement("TextLabel",{
	Size=UDim2.new(0,50,1,0),
	Position=UDim2.new(0,0,0,0),
	BackgroundTransparency=1,
	Text="SPEED: "..flightSpeed,
	Font=Enum.Font.GothamBold,
	TextSize=14,
	TextColor3=Color3.fromRGB(255,255,255),
	TextScaled=true
}, speedFrame)
local speedSlider = createElement("Frame",{
	Size=UDim2.new(0,135,0,10),
	Position=UDim2.new(0,55,0,8),
	BackgroundColor3=Color3.fromRGB(50,50,50),
	BackgroundTransparency=0.6,
	BorderSizePixel=0
}, speedFrame)
createElement("UICorner",{CornerRadius=UDim.new(0,5)}, speedSlider)
local speedKnob = createElement("Frame",{
	Size=UDim2.new(0,15,0,10),
	Position=UDim2.new((flightSpeed-10)/390,-7.5,0,0),
	BackgroundColor3=Color3.fromRGB(255,255,255),
	BackgroundTransparency=0.2,
	BorderSizePixel=0
}, speedSlider)
createElement("UICorner",{CornerRadius=UDim.new(0,5)}, speedKnob)

-- Dragging
local dragging, dragStartPos, dragStartMousePos = false
titleBar.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType==Enum.UserInputType.Touch then
		dragging = true
		dragStartPos = mainFrame.Position
		dragStartMousePos = input.Position
	end
end)
titleBar.InputChanged:Connect(function(input)
	if dragging and (input.UserInputType==Enum.UserInputType.MouseMovement or input.UserInputType==Enum.UserInputType.Touch) then
		local delta = input.Position - dragStartMousePos
		mainFrame.Position = UDim2.new(dragStartPos.X.Scale, dragStartPos.X.Offset+delta.X, dragStartPos.Y.Scale, dragStartPos.Y.Offset+delta.Y)
	end
end)
UserInputService.InputEnded:Connect(function(input)
	if input.UserInputType==Enum.UserInputType.MouseButton1 or input.UserInputType==Enum.UserInputType.Touch then
		dragging = false
	end
end)

-- Slider logic
local sliderDragging = false
local function updateSlider(mousePos)
	local sliderPos = speedSlider.AbsolutePosition
	local sliderSize = speedSlider.AbsoluteSize
	local relativeX = mousePos.X - sliderPos.X
	local percentage = math.clamp(relativeX/sliderSize.X,0,1)
	flightSpeed = math.floor(10+(percentage*390))
	speedLabel.Text="SPEED: "..flightSpeed
	speedKnob.Position = UDim2.new(percentage,-7.5,0,0)
end
speedSlider.InputBegan:Connect(function(input)
	if input.UserInputType==Enum.UserInputType.MouseButton1 or input.UserInputType==Enum.UserInputType.Touch then
		sliderDragging=true
		updateSlider(input.Position)
	end
end)
speedKnob.InputBegan:Connect(function(input)
	if input.UserInputType==Enum.UserInputType.MouseButton1 or input.UserInputType==Enum.UserInputType.Touch then
		sliderDragging=true
	end
end)
UserInputService.InputChanged:Connect(function(input)
	if sliderDragging and (input.UserInputType==Enum.UserInputType.MouseMovement or input.UserInputType==Enum.UserInputType.Touch) then
		updateSlider(input.Position)
	end
end)
UserInputService.InputEnded:Connect(function(input)
	sliderDragging=false
end)

-- Keybind
keybindButton.MouseButton1Click:Connect(function()
	waitingForKeybind=true
	keybindButton.Text="PRESS ANY KEY..."
	keybindButton.BackgroundTransparency=0.4
end)

-- Minimize / restore
local fullPositions = {toggle=toggleButton.Position, speed=speedFrame.Position, key=keybindButton.Position}
local function tweenElements(minimize)
    local tweenInfo = TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)

    if minimize then
        -- Shrink main frame
        TweenService:Create(mainFrame, tweenInfo, {Size=UDim2.new(0,205,0,30)}):Play()

        -- Move and hide elements
        toggleButton.Visible = false
        keybindButton.Visible = false
        speedFrame.Visible = false
    else
        -- Restore main frame
        TweenService:Create(mainFrame, tweenInfo, {Size=UDim2.new(0,205,0,95)}):Play()

        -- Show elements
        toggleButton.Visible = true
        keybindButton.Visible = true
        speedFrame.Visible = true
    end
end
minimizeButton.MouseButton1Click:Connect(function()
	isMinimized = not isMinimized
	tweenElements(isMinimized)
end)

-- Movement input handling
UserInputService.InputBegan:Connect(function(input, gameProcessed)
	if gameProcessed then return end
	if not isFlying then return end
	if input.KeyCode == Enum.KeyCode.W then moveState.forward = 1 end
	if input.KeyCode == Enum.KeyCode.S then moveState.backward = 1 end
	if input.KeyCode == Enum.KeyCode.A then moveState.left = 1 end
	if input.KeyCode == Enum.KeyCode.D then moveState.right = 1 end
end)

UserInputService.InputEnded:Connect(function(input, gameProcessed)
	if gameProcessed then return end
	if not isFlying then return end
	if input.KeyCode == Enum.KeyCode.W then moveState.forward = 0 end
	if input.KeyCode == Enum.KeyCode.S then moveState.backward = 0 end
	if input.KeyCode == Enum.KeyCode.A then moveState.left = 0 end
	if input.KeyCode == Enum.KeyCode.D then moveState.right = 0 end
end)

-- Global Input
local function onGlobalInput(input, gameProcessed)
	if gameProcessed then return end
	if waitingForKeybind and input.UserInputType==Enum.UserInputType.Keyboard then
		local ignored={Enum.KeyCode.LeftShift,Enum.KeyCode.RightShift,Enum.KeyCode.LeftControl,Enum.KeyCode.RightControl,Enum.KeyCode.LeftAlt,Enum.KeyCode.RightAlt,Enum.KeyCode.LeftSuper,Enum.KeyCode.RightSuper,Enum.KeyCode.Unknown}
		for _,key in ipairs(ignored) do if input.KeyCode==key then return end end
		waitingForKeybind=false
		toggleKey=input.KeyCode
		keybindButton.Text="KEYBIND: "..toggleKey.Name
		keybindButton.BackgroundTransparency=0.25
	elseif input.KeyCode==toggleKey then
		toggleButton.Text="FLY: "..(isFlying and "OFF" or "ON")
		isFlying = not isFlying
		if isFlying then
			Workspace.Gravity=0
			humanoid.PlatformStand=true
			playAnimation(10714347256,4,0)
			local gyro=Instance.new("BodyGyro",hrp)
			gyro.Name="FlyGyro"; gyro.P=90000; gyro.MaxTorque=Vector3.new(9e9,9e9,9e9)
			local bv=Instance.new("BodyVelocity",hrp)
			bv.Name="FlyVelocity"; bv.MaxForce=Vector3.new(9e9,9e9,9e9)
			currentVelocity=Vector3.new(0,0,0)

			-- Flight loop with corrected rotation and animation
			table.insert(flightConns, RunService.RenderStepped:Connect(function()
				local cam=Workspace.CurrentCamera
				local fwd=moveState.forward-moveState.backward
				local side=moveState.right-moveState.left

				local inputVec=(cam.CFrame.LookVector*fwd)+(cam.CFrame.RightVector*side)
				if inputVec.Magnitude>0 then inputVec=inputVec.Unit end

				local bobbing=math.sin(tick()*bobbingFrequency)*bobbingAmplitude
				local desiredVelocity=inputVec.Magnitude>0 and inputVec*flightSpeed or Vector3.new(0,bobbing,0)
				currentVelocity=currentVelocity:Lerp(desiredVelocity,0.25)
				if hrp:FindFirstChild("FlyVelocity") then hrp.FlyVelocity.Velocity=currentVelocity end

				local targetLook=inputVec.Magnitude>0 and inputVec or hrp.CFrame.LookVector
				local targetCF=CFrame.new(hrp.Position,hrp.Position+targetLook)
				local pitch=-fwd*math.rad(15)
				local roll=side*math.rad(12)
				targetCF=targetCF*CFrame.Angles(pitch,0,roll)
				currentCF=currentCF and currentCF:Lerp(targetCF,lerpCoef) or targetCF
				if hrp:FindFirstChild("FlyGyro") then hrp.FlyGyro.CFrame=currentCF end
			end))
		else
			Workspace.Gravity=originalGravity
			humanoid.PlatformStand=false
			stopAnimation()
			if hrp:FindFirstChild("FlyGyro") then hrp.FlyGyro:Destroy() end
			if hrp:FindFirstChild("FlyVelocity") then hrp.FlyVelocity:Destroy() end
			for _,conn in ipairs(flightConns) do if conn.Connected then conn:Disconnect() end end
			flightConns={}
			moveState={forward=0,backward=0,left=0,right=0}
		end
	end
end
local globalInputConn = UserInputService.InputBegan:Connect(onGlobalInput)
table.insert(globalConns, globalInputConn)

-- Toggle button click triggers key
toggleButton.MouseButton1Click:Connect(function()
	onGlobalInput({KeyCode=toggleKey,UserInputType=Enum.UserInputType.Keyboard},false)
end)

-- Close button
closeButton.MouseButton1Click:Connect(function()
	if isFlying then
		isFlying=false
		Workspace.Gravity=originalGravity
		humanoid.PlatformStand=false
		stopAnimation()
		if hrp:FindFirstChild("FlyGyro") then hrp.FlyGyro:Destroy() end
		if hrp:FindFirstChild("FlyVelocity") then hrp.FlyVelocity:Destroy() end
		for _,conn in ipairs(flightConns) do if conn.Connected then conn:Disconnect() end end
	end
	for _,conn in ipairs(globalConns) do if conn.Connected then conn:Disconnect() end end
	flyGui:Destroy()
	script:Destroy()
end)

-- Character respawn handling
player.CharacterAdded:Connect(function(newChar)
	character=newChar
	humanoid=character:WaitForChild("Humanoid")
	hrp=character:WaitForChild("HumanoidRootPart")
	if isFlying then
		isFlying=false
		Workspace.Gravity=originalGravity
		humanoid.PlatformStand=false
		stopAnimation()
		if hrp:FindFirstChild("FlyGyro") then hrp.FlyGyro:Destroy() end
		if hrp:FindFirstChild("FlyVelocity") then hrp.FlyVelocity:Destroy() end
		for _,conn in ipairs(flightConns) do if conn.Connected then conn:Disconnect() end end
		flightConns={}
		moveState={forward=0,backward=0,left=0,right=0}
	end
end)
